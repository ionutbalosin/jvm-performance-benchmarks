name: PR Quality Check

on:
  pull_request:
    branches: [ main, master, develop ]
    types: [ opened, synchronize, reopened ]

jobs:
  spotless-check:
    name: Code Formatting Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Run Spotless Check
        run: ./mvnw spotless:check

      - name: Comment PR on formatting failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Code formatting check failed!**\n\nPlease run `./mvnw spotless:apply` locally to fix formatting issues, then commit and push the changes.\n\nAlternatively, you can run the formatting workflow by commenting `/format` on this PR.'
            })

  build-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build and Test
        run: ./mvnw clean package

      - name: Comment PR on build failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Build failed!**\n\nThe build failed during `./mvnw clean package`. Please check the logs above and fix any compilation or test errors.'
            })

  pr-status:
    name: PR Status Summary
    runs-on: ubuntu-latest
    needs: [spotless-check, build-test]
    if: always()

    steps:
      - name: Check overall status and comment
        uses: actions/github-script@v7
        with:
          script: |
            const spotlessResult = '${{ needs.spotless-check.result }}';
            const buildResult = '${{ needs.build-test.result }}';
            
            let message = '## PR Quality Check Results\n\n';
            
            // Spotless check status
            if (spotlessResult === 'success') {
              message += '‚úÖ **Code Formatting**: Passed\n';
            } else if (spotlessResult === 'failure') {
              message += '‚ùå **Code Formatting**: Failed\n';
            } else {
              message += '‚ö†Ô∏è **Code Formatting**: ' + spotlessResult + '\n';
            }
            
            // Build check status
            if (buildResult === 'success') {
              message += '‚úÖ **Build & Test**: Passed\n';
            } else if (buildResult === 'failure') {
              message += '‚ùå **Build & Test**: Failed\n';
            } else {
              message += '‚ö†Ô∏è **Build & Test**: ' + buildResult + '\n';
            }
            
            message += '\n';
            
            if (spotlessResult === 'success' && buildResult === 'success') {
              message += 'üéâ **All checks passed!** This PR is ready for review.';
            } else {
              message += '‚ö†Ô∏è **Some checks failed.** Please review the issues above and fix them before requesting a review.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });